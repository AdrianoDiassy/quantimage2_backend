version: '3.9'

services:
  backend:
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=prod"
      - "traefik.http.services.quantimage2-backend-backend.loadbalancer.server.port=5000"
      - "traefik.http.routers.quantimage2-backend-backend.rule=Host(`${TRAEFIK_URL_FLASKAPP}`)"
    networks:
      - default
      - prod

  celery_extraction:
    env_file:
      - .env

  celery_training:
    env_file:
      - .env

  phpmyadmin:
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=prod"
      - "traefik.http.routers.quantimage2-backend-phpmyadmin.rule=Host(`${TRAEFIK_URL_PHPMYADMIN}`)"
    networks:
      - default
      - prod

  keycloak:
    environment:
      - PROXY_ADDRESS_FORWARDING=true
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=prod"
      - "traefik.http.routers.quantimage2-backend-keycloak.rule=Host(`${TRAEFIK_URL_KEYCLOAK}`)"
    networks:
      - default
      - prod

  ohif:
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=prod"
      - "traefik.http.routers.quantimage2-backend-ohif.rule=Host(`${TRAEFIK_URL_OHIF}`)"
    networks:
      - default
      - prod

  flower:
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=prod"
      - "traefik.http.middlewares.quantimage2-backend-flower-auth.basicauth.users=${TRAEFIK_FLOWER_USERS}"
      - "traefik.http.routers.quantimage2-backend-flower.rule=Host(`${TRAEFIK_URL_FLOWER}`)"
      - "traefik.http.routers.quantimage2-backend-flower.middlewares=quantimage2-backend-flower-auth"
    networks:
      - default
      - prod

networks:
  prod:
    external: true
    name: ${TRAEFIK_NETWORK}
